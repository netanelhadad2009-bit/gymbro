/**
 * Journey Page - Game-style 3D Map View
 *
 * Premium game UI with energy badges and dynamic paths
 */

"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { GameMap } from "@/components/journey/GameMap";
import { useJourney } from "@/lib/journey/client";
import { motion } from "framer-motion";
import { AlertTriangle, Map, Home } from "lucide-react";
import type { JourneyNode } from "@/lib/journey/queries";

// Static demo data for fallback
const DEMO_DATA = {
  chapters: [
    {
      id: 1,
      title: "×¤×¨×§ 1: ×”×‘×¡×™×¡",
      description: "×‘× ×™×™×ª ×”×¨×’×œ×™× ×¨××©×•× ×™×™×"
    },
    {
      id: 2,
      title: "×¤×¨×§ 2: ×”×ª×§×“××•×ª",
      description: "×”×¢××§×ª ×”××—×•×™×‘×•×ª"
    }
  ],
  nodes: [
    {
      id: "demo-1",
      chapter_id: 1,
      title: "×”×ª×—×œ×ª ×”××¡×¢",
      description: "×”×¦×¢×“ ×”×¨××©×•×Ÿ ×©×œ×š",
      icon: "ğŸš€",
      points: 10,
      order_index: 0,
      primary_task: "weigh_in_today",
      conditions_json: {
        checklist: ["weigh_in_today"]
      },
      progress: {
        state: "ACTIVE" as const,
        started_at: new Date().toISOString(),
        completed_at: null,
        progress_json: {}
      }
    },
    {
      id: "demo-2",
      chapter_id: 1,
      title: "×ª×™×¢×•×“ ××¨×•×—×•×ª",
      description: "×œ××“ ×œ×ª×¢×“ ××ª ×”×ª×–×•× ×” ×©×œ×š",
      icon: "ğŸ½ï¸",
      points: 20,
      order_index: 1,
      primary_task: "log_2_meals",
      conditions_json: {
        checklist: ["log_2_meals"]
      },
      progress: {
        state: "AVAILABLE" as const,
        started_at: null,
        completed_at: null,
        progress_json: {}
      }
    },
    {
      id: "demo-3",
      chapter_id: 1,
      title: "×™×¢×“ ×—×œ×‘×•×Ÿ",
      description: "×”×©×’ ××ª ×™×¢×“ ×”×—×œ×‘×•×Ÿ ×”×™×•××™",
      icon: "ğŸ¥©",
      points: 30,
      order_index: 2,
      primary_task: "protein_min",
      conditions_json: {
        checklist: ["protein_min", "log_3_meals"]
      },
      progress: {
        state: "LOCKED" as const,
        started_at: null,
        completed_at: null,
        progress_json: {}
      }
    },
    {
      id: "demo-4",
      chapter_id: 2,
      title: "×¨×¦×£ ×©×‘×•×¢×™",
      description: "×©××•×¨ ×¢×œ ×¨×¦×£ ×©×œ 7 ×™××™×",
      icon: "ğŸ“…",
      points: 50,
      order_index: 3,
      primary_task: "log_streak_7",
      conditions_json: {
        checklist: ["log_streak_7", "weigh_in_today"]
      },
      progress: {
        state: "LOCKED" as const,
        started_at: null,
        completed_at: null,
        progress_json: {}
      }
    }
  ] as JourneyNode[],
  total_points: 0,
  total_badges: 0
};

export default function JourneyPageV2() {
  const router = useRouter();
  const { data, loading, error, refetch } = useJourney();

  // Mount verification
  useEffect(() => {
    console.log('[JourneyV2] ğŸ® GameMap 3D mounted âœ”ï¸');
    console.log('[JourneyV2] Components: GameMap, GameNode, EnergyPath, XPCounter');
  }, []);

  // Use demo data if API returns empty or has error
  const journeyData = (data && data.chapters && data.chapters.length > 0) ? {
    chapters: data.chapters,
    nodes: data.chapters.flatMap(c => c.nodes),
    userPoints: data.total_points
  } : {
    chapters: DEMO_DATA.chapters,
    nodes: DEMO_DATA.nodes,
    userPoints: DEMO_DATA.total_points
  };

  console.log("[JourneyUI] Page render:", {
    loading,
    error: !!error,
    chapters: journeyData.chapters.length,
    nodes: journeyData.nodes.length,
    userPoints: journeyData.userPoints
  });

  // Error state with game aesthetic - only show for network errors
  if (error && error.includes("NetworkError")) {
    return (
      <div className="fixed inset-0 bg-gradient-to-b from-[#0e0f12] to-[#1a1b20] flex items-center justify-center" dir="rtl">
        {/* Animated background particles */}
        <div className="absolute inset-0 overflow-hidden">
          {[...Array(20)].map((_, i) => (
            <motion.div
              key={i}
              className="absolute w-1 h-1 bg-orange-400/30 rounded-full"
              style={{
                left: `${Math.random() * 100}%`,
                top: `${Math.random() * 100}%`,
              }}
              animate={{
                y: [-20, 20, -20],
                opacity: [0.3, 0.8, 0.3]
              }}
              transition={{
                duration: 3 + Math.random() * 2,
                repeat: Infinity,
                delay: Math.random() * 3
              }}
            />
          ))}
        </div>

        <motion.div
          initial={{ scale: 0.9, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          className="relative z-10 text-center p-8 rounded-3xl bg-gradient-to-br from-neutral-900/95 to-black/95 backdrop-blur-xl border border-orange-500/20 shadow-[0_0_40px_rgba(249,115,22,0.2)]"
        >
          <motion.div
            animate={{ rotate: [0, 5, -5, 0] }}
            transition={{ duration: 2, repeat: Infinity }}
            className="inline-flex p-6 rounded-full bg-gradient-to-br from-orange-500/20 to-orange-600/10 mb-6"
          >
            <AlertTriangle className="w-16 h-16 text-orange-400" />
          </motion.div>
          <h2 className="text-2xl font-black text-white mb-3">×©×’×™××ª ×—×™×‘×•×¨</h2>
          <p className="text-neutral-400 mb-8 max-w-xs">×œ× ×”×¦×œ×—× ×• ×œ×˜×¢×•×Ÿ ××ª ×”××¡×¢ ×©×œ×š. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ×¨×©×ª ×•× ×¡×” ×©×•×‘.</p>
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => refetch()}
            className="px-8 py-4 bg-gradient-to-r from-orange-400 to-orange-500 text-black font-bold rounded-2xl shadow-[0_8px_32px_rgba(249,115,22,0.3)] hover:shadow-[0_12px_40px_rgba(249,115,22,0.4)] transition-all"
          >
            × ×¡×” ×©×•×‘
          </motion.button>
        </motion.div>
      </div>
    );
  }

  // Loading state with game aesthetic
  if (loading) {
    return (
      <div className="fixed inset-0 bg-gradient-to-b from-[#0e0f12] to-[#1a1b20] flex items-center justify-center" dir="rtl">
        {/* Animated loading rings */}
        <div className="relative">
          {[0, 1, 2].map((i) => (
            <motion.div
              key={i}
              className="absolute inset-0 rounded-full border-2 border-[#E2F163]/30"
              style={{
                width: 80 + i * 30,
                height: 80 + i * 30,
                left: `50%`,
                top: `50%`,
                transform: "translate(-50%, -50%)"
              }}
              animate={{
                scale: [1, 1.2, 1],
                opacity: [0.3, 0.6, 0.3],
                rotate: i % 2 === 0 ? [0, 360] : [360, 0]
              }}
              transition={{
                duration: 3,
                repeat: Infinity,
                delay: i * 0.3,
                ease: "easeInOut"
              }}
            />
          ))}
          <motion.div
            animate={{ rotate: 360 }}
            transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
            className="relative z-10 w-20 h-20 rounded-full bg-gradient-to-br from-[#E2F163] to-[#d4e350] flex items-center justify-center shadow-[0_0_40px_rgba(226,241,99,0.4)]"
          >
            <Map className="w-10 h-10 text-black" />
          </motion.div>
        </div>
        <motion.p
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
          className="absolute bottom-32 text-neutral-400 font-semibold"
        >
          ×˜×•×¢×Ÿ ××ª ×”××¡×¢ ×©×œ×š...
        </motion.p>
      </div>
    );
  }

  // Empty state with game aesthetic (shouldn't happen with demo data)
  if (!journeyData.nodes.length) {
    return (
      <div className="fixed inset-0 bg-gradient-to-b from-[#0e0f12] to-[#1a1b20] flex items-center justify-center" dir="rtl">
        <motion.div
          initial={{ scale: 0.9, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          className="text-center p-8 rounded-3xl bg-gradient-to-br from-neutral-900/95 to-black/95 backdrop-blur-xl border border-neutral-700/30"
        >
          <motion.div
            animate={{ y: [0, -10, 0] }}
            transition={{ duration: 2, repeat: Infinity }}
            className="inline-flex p-6 rounded-full bg-gradient-to-br from-neutral-800/50 to-neutral-900/30 mb-6"
          >
            <Map className="w-16 h-16 text-neutral-500" />
          </motion.div>
          <h2 className="text-2xl font-black text-white mb-3">×”××¡×¢ ×‘×‘× ×™×™×”</h2>
          <p className="text-neutral-400 mb-8 max-w-xs">×”××¡×¢ ×©×œ×š ×™×”×™×” ×–××™×Ÿ ×‘×§×¨×•×‘. ×—×–×•×¨ ×××•×—×¨ ×™×•×ª×¨ ×œ×—×•×•×™×” ××œ××”!</p>
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => router.push("/")}
            className="px-8 py-4 bg-gradient-to-r from-[#E2F163] to-[#d4e350] text-black font-bold rounded-2xl shadow-[0_8px_32px_rgba(226,241,99,0.3)] hover:shadow-[0_12px_40px_rgba(226,241,99,0.4)] transition-all flex items-center justify-center gap-2"
          >
            <Home className="w-5 h-5" />
            ×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª
          </motion.button>
        </motion.div>
      </div>
    );
  }

  // Main game map view
  return (
    <GameMap
      nodes={journeyData.nodes}
      chapters={journeyData.chapters}
      userPoints={journeyData.userPoints}
      onRefresh={refetch}
    />
  );
}